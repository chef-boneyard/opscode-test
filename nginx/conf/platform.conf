worker_processes  1;
pid /tmp/nginx.pid;

events {
    worker_connections  1024;
    #debug_connection 127.0.0.1;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    map_hash_max_size 4096;
    map_hash_bucket_size  64;
    map $uri $sql_nodes {
      default 1;
      include sql_nodes_darklaunch.conf;
    }

    access_log  /tmp/platform-nginx-access.log;
    error_log  /tmp/platform-nginx-error.log debug;

    gzip  on;
    gzip_http_version 1.0;
    gzip_comp_level 2;
    gzip_proxied any;
    gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;
    tcp_nodelay on;

    root /srv/opscode-lb/html;

    server {
      listen 9021;

      proxy_connect_timeout   90;
      proxy_send_timeout      90;
      proxy_read_timeout      90;
      proxy_redirect          off;
      proxy_ignore_client_abort  on;
      proxy_set_header        Host            $host:$proxy_port;
      proxy_set_header        X-Real-IP       $remote_addr;
      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass_request_headers on;

      error_page 404 /404.html;
      error_page 406 = /406.html;
      client_max_body_size       250m;
      client_body_buffer_size    2m;


      location / {
        index index.html;
      }

      location ~ "^/organizations/[a-z0-9-]+?/.*?/_acl.*$" {
        proxy_pass http://127.0.0.1:4042;
      }

      # erchef
      # 
      # By default, erchef runs on port 4001.  This config directs
      # erchef traffic to 9898 and assumes you are running a port
      # forwarding process like socat for extra debugging goodness.
      # Here's how I run it:
      # 
      #     socat -v TCP4-LISTEN:9898,fork TCP4:127.0.0.1:4001
      # 
      # This gives a readable trace of the raw HTTP interaction and is
      # very useful for development and debugging.  You can switch
      # back to non-erchef pure ruby by changing the forwarding rule
      # in socat from 4001 to 4000.  So that gives you a nice way to
      # A/B ruby vs erchef.

      # search goes to erchef
      location ~ "^/organizations/[a-z0-9-]+?/search/{0,1}.*$" {
        proxy_pass http://127.0.0.1:9898;
      }

      # backwards compatible for Chef 0.9.x and below clients
      # the nodes/:node_name/cookbooks is still handled by Ruby-Chef
      location ~ "^/organizations/[a-z0-9-]+?/nodes/[^/]+/cookbooks$" {
        proxy_pass http://127.0.0.1:4000;
      }

      # Node listing within an environment is handled by erchef
      location ~ "^/organizations/[a-z0-9-]+?/environments/[^/]+/nodes$" {
        proxy_pass http://127.0.0.1:9898;
      }

      # nodes goes to erchef based on nginx darklaunch config
      location ~ "^/organizations/[a-z0-9-]+?/nodes/{0,1}.*$" {
        if ($sql_nodes = 1) {
           rewrite ^/(.*)$ /SQL_NODES/$1 last;
        }
        rewrite ^/(.*)$ /NOSQL_NODES/$1 last;
      }

      location ~ "^/SQL_NODES" {
        rewrite ^/SQL_NODES/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:9898;
      }

      location ~ "^/NOSQL_NODES" {
        rewrite ^/NOSQL_NODES/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:4000;
      }
      
      location ~ "^/organizations/[a-z0-9-]+?/(?:nodes|status|cookbooks|data|roles|sandboxes|environments)/{0,1}.*$" {
        proxy_pass http://127.0.0.1:4000;
      }

      location ~ "^/organizations/[a-z0-9-]+?/(?:groups|users|clients|containers|association_requests)/{0,1}.*$" {
        proxy_pass http://127.0.0.1:4042;
      }

      # NOTE: this is different from external LB. internal-organizations is for
      # internal, obviously.
      location ~ "^/(?:organizations|internal-organizations|users)/{0,1}$" {
        proxy_pass http://127.0.0.1:4042;
      }

      # NOTE: this differs from the production External LB config.
      # we may be blocking this at external LB to prevent users from screwing themselves,
      # so ask around before changing this in prod.
      location ~ "^/users/[a-z0-9-_]+/_acl.*$" {
        proxy_pass http://127.0.0.1:4042;
      }

      location ~ "^/users/[a-z0-9-_]+/{0,1}/association_requests/{0,1}.*$" {
        proxy_pass http://127.0.0.1:4042;
      }


      # NOTE: this is different from external LB. internal-organizations is for
      # internal, obviously.
      location ~ "^/(?:organizations|internal-organizations)/[a-z0-9-\_]+.*$" {
        proxy_pass http://127.0.0.1:4042;
      }

      location ~ "^/internal-organizations/{0,1}$" {
        proxy_pass http://127.0.0.1:4042;
      }

      location ~ "^/internal-organizations/[a-z0-9-]+/{0,1}$" {
        proxy_pass http://127.0.0.1:4042;
      }

      location ~ "^/internal-users/{0,1}$" {
        proxy_pass http://127.0.0.1:4042;
      }

      location ~ "^/users/[a-z0-9-]+/{0,1}$" {
        proxy_pass http://127.0.0.1:4042;
      }

      location ~ "^/users/[a-z0-9-_]+/{0,1}/association_requests/{0,1}.*$" {
        proxy_pass http://127.0.0.1:4042;
      }

      location ~ "^/users/[a-z0-9-]+/organizations/{0,1}$" {
        proxy_pass http://127.0.0.1:4042;
      }

      location ~ "^/verify_password$" {
        proxy_pass http://127.0.0.1:4042;
      }

    }

    server {
      listen 3005;

      proxy_connect_timeout   90;
      proxy_send_timeout      90;
      proxy_read_timeout      90;
      proxy_redirect          off;
      proxy_ignore_client_abort  on;
      proxy_set_header        Host            $host;
      proxy_set_header        X-Real-IP       $remote_addr;
      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass_request_headers on;

      error_page 404 /404.html;
      error_page 406 = /406.html;
      client_max_body_size       250m;
      client_body_buffer_size    2m;
      add_header P3P "CP=\"CAO PSA OUR\"";

      location "/hosted-chef/signup/" {
        proxy_pass http://127.0.0.1:3000/users/megacreate;
      }

      location "/hosted-chef/validate/" {
        proxy_pass http://127.0.0.1:3000/users/validate;
      }

      location "/hosted-chef/update-subscription/" {
        proxy_pass http://127.0.0.1:3000/users/update_subscription;
      }

      location "/" {
        proxy_pass http://127.0.0.1:3001;
      }
    }

    server {
      listen 3006;

      proxy_connect_timeout   90;
      proxy_send_timeout      90;
      proxy_read_timeout      90;
      proxy_redirect          off;
      proxy_ignore_client_abort  on;
      proxy_set_header        Host            $host;
      proxy_set_header        X-Real-IP       $remote_addr;
      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass_request_headers on;

      error_page 404 /404.html;
      error_page 406 = /406.html;
      client_max_body_size       250m;
      client_body_buffer_size    2m;

      # Yes, this is hardcoded to what happens to be the only subfolder of the
      # bucket we are currently using. If we start using another folder make
      # sure to extend this.
      location "/cookbook_versions/" {
        rewrite      (.*) /opscode-community-dev$1 break;
        proxy_pass   http://127.0.0.1:3002;
      }

      location "/" {
        proxy_pass http://127.0.0.1:3000;
        proxy_redirect default;
        proxy_redirect http://localhost/ http://$host:$server_port/;
      }
    }

}


