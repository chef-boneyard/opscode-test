#! /usr/bin/env ruby

require 'rubygems'
$:.unshift(File.expand_path('../../lib', __FILE__))

require 'opscode/test'
require 'opscode/test/config'
require 'opscode/test/database_config'
require 'opscode/test/database_helper'
require 'opscode/test/dsl'
require 'opscode/test/models/superuser'
require 'restclient'
require 'json'
require 'opscode/mappers'

Opscode::Test.configure do |c|
  c.output_directory = '/tmp/opscode-platform-test'

  c.mysql_host = 'localhost'
  c.mysql_user = 'root'
  c.mysql_password = ''

  c.couchdb_host = 'localhost'
  c.couchdb_port = '5984'

  c.couchdbauthz_host = 'localhost'
  c.couchdbauthz_port = '5984'

  c.authz_host = 'localhost'
  c.authz_port = '5959'

  c.cert_host = 'localhost'
  c.cert_port = '5140'

  c.superuser_cert = '/tmp/opscode-platform-test/superuser.cert'
  c.superuser_key  = '/tmp/opscode-platform-test/superuser.pem'
end

config = Opscode::Test.config
include Opscode::Test::DSL

######################################################################
# warning, for Tim
######################################################################

# TODO: print out a warning with the configuration variables, stating
# that you are about to do some serious damage

######################################################################
# from this point on, this should be an eval'd script
######################################################################

create_credentials_dir

truncate_sql_tables

delete_couchdb_databases

create_couchdb_databases

# load the superuser cert and key from a file
cert_file = File.read(config.superuser_cert)
user_cert = OpenSSL::X509::Certificate.new(cert_file)

key_file = File.read(config.superuser_key)
user_key = OpenSSL::PKey::RSA.new(key_file)

su_authz_id = superuser do |u|
  u.name = 'platform-superuser'
  u.first_name = 'Clark'
  u.last_name = 'Kent'
  u.display_name = ' Clark Kent'
  u.email = 'kryptonite@opscode.com'
  u.password = 'kryptonite'
  u.certificate = user_cert.to_s
end

create_global_containers(su_authz_id)

